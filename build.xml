<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="DoItAll" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" >

  <PropertyGroup>
    <NUnit-ToolPath>$(MSBuildProjectDirectory)\packages\NUnit.Runners.2.6.0.12051\tools\</NUnit-ToolPath>
    <OpenCover-ToolPath>$(MSBuildProjectDirectory)\packages\OpenCover.4.0.519\</OpenCover-ToolPath>
    <ReportGenerator-ToolPath>$(MSBuildProjectDirectory)\packages\ReportGenerator.1.4.1.0\</ReportGenerator-ToolPath>
    <MSBuildCommunityTasksPath>$(MSBuildProjectDirectory)\tools\msbuild\MSBuildCommunityTasks\</MSBuildCommunityTasksPath>
    <SolutionRoot>$(MSBuildProjectDirectory)\</SolutionRoot>
  </PropertyGroup>
  <Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets"/>
  <UsingTask TaskName="SetEnvVariable"
             AssemblyFile="$(SolutionRoot)\tools\MSBuild.SetEnvVariable\MSBuild.SetEnvVariable.dll"/>

  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">Any CPU</Platform>
    <MajorVersion>1</MajorVersion>
    <MinorVersion>0</MinorVersion>
    <!-- This gets set by the build server -->
    <BuildVersion>0</BuildVersion>
    <FullVersion>$(MajorVersion).$(MinorVersion).$(BuildVersion)</FullVersion>

    <LiveDeploymentTarget>metrics.labs.cityindex.com</LiveDeploymentTarget>

    <!-- list of test assemblies (space separated) -->
    <TestAssemblies>$(MSBuildProjectDirectory)\_bin\$(Configuration)\Tests.Analytics.dll $(MSBuildProjectDirectory)\_bin\$(Configuration)\Tests.Functional.dll</TestAssemblies>
    <!-- list of assembly filters (space separated) - see https://github.com/sawilde/opencover/wiki/Usage -filter: for syntax-->
    <OpenCoverFilter>+[*]* -[Test*]* -[ApiGeoIP*]* -[CassiniDev*]*</OpenCoverFilter>
  </PropertyGroup>

  <Target Name="UpdateVersion" >
    <Message Text="Updating version to $(FullVersion)" />
    <!-- Update assembly version number using build number -->
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\AppMetrics\Properties\AssemblyInfo.cs"
        Regex="AssemblyVersion\(&quot;.*&quot;\)"
        ReplacementText="AssemblyVersion(&quot;$(FullVersion)&quot;)" />
  </Target>

  <Target Name="Build" DependsOnTargets="UpdateVersion" >
    <MSBuild Projects="$(MSBuildProjectDirectory)\AppMetrics.sln" Targets="Rebuild"
      Properties="Configuration=$(Configuration)" />
  </Target>

  <Target Name="RunTests" DependsOnTargets="Build">
    <Message Text="Executing Unit Tests and running OpenCover to check code coverage..." />

    <SetEnvVariable Name="AppMetricsTest_ServiceRootFolder" Value="$(AppMetricsTest_ServiceRootFolder)"/>
    <SetEnvVariable Name="AppMetricsTest_DataFolder" Value="$(AppMetricsTest_DataFolder)"/>

    <RemoveDir Directories="_data" />
    <MakeDir Directories="_data" />

    <RemoveDir Directories="_reports" />
    <MakeDir Directories="_reports" />
    <Exec Command='"$(OpenCover-ToolPath)\OpenCover.Console.exe" -register:user -target:"$(NUnit-ToolPath)\nunit-console-x86.exe" "-targetargs:$(TestAssemblies)" "-targetdir:$(MSBuildProjectDirectory)\_bin\$(Configuration)" "-filter:$(OpenCoverFilter)" -output:_reports\CodeCoverageResults.xml' />
    <Exec Command='$(ReportGenerator-ToolPath)ReportGenerator.exe "-reports:_reports\CodeCoverageResults.xml" "-targetdir:_reports\coveragereport" "-reporttypes:html;htmlsummary;xmlsummary"' />
  </Target>


  <Target Name="Package" DependsOnTargets="RunTests" >

    <!-- package data collector website -->
    <FileUpdate
      Files="$(MSBuildProjectDirectory)\AppMetrics\App_Data\web.config"
      Regex="(DataStoragePath&quot; value=)&quot;[^&quot;]*&quot;"
      ReplacementText="$1&quot;~/../_AppMetricsData/&quot;" />

    <MSBuild Projects="$(MSBuildProjectDirectory)\AppMetrics\AppMetrics.csproj" Targets="Package"
      Properties="Configuration=$(Configuration)" />

    <ItemGroup>
      <PackageSourceFiles Include="$(MSBuildProjectDirectory)\_package\Tracker\**\*.*" />
    </ItemGroup>

    <Copy SourceFiles="@(PackageSourceFiles)" DestinationFolder="$(MSBuildProjectDirectory)\_package\TrackerLive\" />

    <FileUpdate
      Files="$(MSBuildProjectDirectory)\_package\TrackerLive\AppMetrics.SetParameters.xml"
      Regex="(name=&quot;IIS Web Application Name&quot; *?value=)&quot;[^&quot;]*&quot;"
      ReplacementText="$1&quot;$(LiveDeploymentTarget)&quot;" />

    <!-- store parameters in the file to be used in other build jobs -->
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\ContinuousIntegration\properties.xml"
        Regex="(MyBuildNumber)&gt;.*?&lt;(/MyBuildNumber)"
        ReplacementText="$1&gt;$(BuildVersion)&lt;$2" />
    <FileUpdate
        Files="$(MSBuildProjectDirectory)\ContinuousIntegration\properties.xml"
        Regex="(FullVersion)&gt;.*?&lt;(/FullVersion)"
        ReplacementText="$1&gt;$(FullVersion)&lt;$2" />

    <!-- set version for NuGet package spec -->
    <FileUpdate
      Files="$(MSBuildProjectDirectory)\_nuget\AppMetrics.Client.nuspec"
      Regex="version&gt;(.*?)&lt;/version"
      ReplacementText="version&gt;$(FullVersion)&lt;/version" />

    <FileUpdate
      Files="$(MSBuildProjectDirectory)\_nuget\AppMetrics.WebUtils.nuspec"
      Regex="version&gt;(.*?)&lt;/version"
      ReplacementText="version&gt;$(FullVersion)&lt;/version" />

    <!-- package analytics website -->
    <FileUpdate
      Files="$(MSBuildProjectDirectory)\AppMetrics.AnalyticsSite\App_Data\web.config"
      Regex="(DataStoragePath&quot; value=)&quot;[^&quot;]*&quot;"
      ReplacementText="$1&quot;~/../_AppMetricsData/&quot;" />

    <MSBuild Projects="$(MSBuildProjectDirectory)\AppMetrics.AnalyticsSite\AppMetrics.AnalyticsSite.csproj" Targets="Package"
      Properties="Configuration=$(Configuration)" />

  </Target>


  <Target Name="DoItAll" DependsOnTargets="Package" >
  </Target>

</Project>
